version: '3.9'

x-common-env: &common-env
  STRUCTS_MONIKER: "${MONIKER}"
  STRUCTS_NETWORK_VERSION: "${NETWORK_VERSION}"
  STRUCTS_CHAIN_ID: "${NETWORK_CHAIN_ID}"

services:
  structsd-network-config:
    image: 'structs/structsd:latest'
    command: ["bash", "/root/scripts/network-config.sh"]
    volumes:
      - chaindata:/root/.structs
      - chainshare:/root/reactor_share
      - chainbackup:/root/reactor_backup
    environment:
      <<: *common-env
  structsd-indexer-config:
    image: 'structs/structsd:latest'
    command: ["bash", "/root/scripts/indexer-config.sh"]
    volumes:
      - chaindata:/root/.structs
    depends_on:
      structsd-network-config:
        condition: service_completed_successfully
      structs-pg:
        condition: service_healthy
        restart: true
    environment:
      <<: *common-env
      STRUCTS_INDEXER_PG_CONNECTION: 'postgres://structs_indexer@structs-pg:5432/structs'
  structsd:
    image: 'structs/structsd:latest'
    hostname: 'structsd'
    volumes:
      - chaindata:/root/.structs
    restart: on-failure
    ports:
      - 26656:26656
      - 26657:26657
      - 1317:1317
    environment:
      <<: *common-env
      STRUCTSD_ARGUMENTS: "${STRUCTSD_ARGUMENTS}"
    healthcheck:
      test: [ "CMD-SHELL", "bash", "/root/scripts/health-check-sync-state.sh" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 48h
    depends_on:
      structsd-network-config:
        condition: service_completed_successfully
      structs-pg:
        condition: service_healthy
        restart: true
      structsd-indexer-config:
        condition: service_completed_successfully
  structs-pg-init:
    image: 'structs/structs-pg:latest'
    hostname: 'structs-pg'
    command: [ "bash", "/src/scripts/database-init.sh" ]
    volumes:
      - pgdata:/var/lib/postgresql/
      - pgetc:/etc/postgresql/
    environment:
      <<: *common-env
      SQITCH_PG_CONNECTION: "${SQITCH_PG_CONNECTION}"
  structs-pg:
    image: 'structs/structs-pg:latest'
    hostname: 'structs-pg'
    volumes:
      - pgdata:/var/lib/postgresql/
      - pgetc:/etc/postgresql/
    ports:
      - ${DIRECT_POSTGRES_PORT}:5432
    restart: on-failure
    depends_on:
      structs-pg-init:
        condition: service_completed_successfully
    healthcheck:
      test: pg_isready
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 10s
    environment:
      DATABSE_NAME: "${DATABASE_NAME}"
  structs-pg-auto-migrate:
    image: 'structs/structs-pg:latest'
    command: [ "bash","/src/scripts/database-auto-migrate.sh" ]
    depends_on:
      structs-pg:
        condition: service_healthy
        restart: true
      structsd:
        condition: service_healthy
        restart: true
    environment:
      <<: *common-env
      AUTO_MIGRATE_SLEEP: "${AUTO_MIGRATE_SLEEP}"
      SQITCH_PG_CONNECTION: "${SQITCH_PG_CONNECTION}"
  structs-proxy:
    image: 'structs/structs-proxy:latest'
    hostname: 'structs-proxy'
    restart: on-failure
    ports:
     - ${PROXY_HTTP_PORT}:80
  structs-nats:
    image: nats
    hostname: 'structs-nats'
    restart: on-failure
    ports:
      - 4222:4222
      - 8222:8222
      - 1443:1443
    command: "-c /etc/nats/nats.conf --cluster_name GRASS --cluster nats://0.0.0.0:6222 --http_port 8222 "
    volumes:
      - ./config/nats/:/etc/nats
  structs-grass:
    image: 'structs/structs-grass:latest'
    hostname: 'structs-grass'
    restart: on-failure
    depends_on:
      structs-pg:
        condition: service_started
    healthcheck:
      test: [ "CMD", "/scripts/health-check.sh" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      PG_CHANNEL: 'grass'
      NAT_HOST: 'nats://structs-nats:4222'
      PG_CONNECTION: 'postgres://structs_indexer@structs-pg:5432/structs'
  structs-webapp:
    image: 'structs/structs-webapp:latest'
    hostname: 'structs-webapp'
    restart: on-failure
    ports:
      - ${DIRECT_WEBAPP_HTTP_PORT}:80
    volumes:
      - type: bind
        source: "${WEBAPP_SOURCE}"
        target: /src
    environment:
      DATABASE_URL: 'postgres://structs_webapp@structs-pg:5432/structs?serverVersion=17'
      NAT_URL: 'nats://structs-nats:4222'
      APP_ENV: "${WEBAPP_APP_ENV}"
      APP_DEBUG: "${WEBAPP_APP_DEBUG}"
      APP_SECRET: "${WEBAPP_APP_SECRET}"
  structs-tsa:
    image: 'structs/structs-tsa:latest'
    hostname: 'structs-tsa'
    restart: on-failure
    volumes:
      - tsa-keyring:/var/structs/accounts
    depends_on:
      structs-pg:
        condition: service_healthy
        restart: true
    environment:
      DATABASE_URL: 'postgres://structs_webapp@structs-pg:5432/structs'
      NAT_URL: 'nats://structs-nats:4222'
      AGENT_TARGET_NUMBER: 30
  structs-crawler:
    image: 'structs/structs-crawler:latest'
    hostname: 'structs-crawler'
    restart: on-failure
    depends_on:
      structs-pg:
        condition: service_healthy
        restart: true
    environment:
      DATABASE_URL: 'postgres://structs_crawler@structs-pg:5432/structs'
  structs-mcp:
    image: 'structs/structs-mcp:latest'
    hostname: 'structs-mcp'
    restart: unless-stopped
    depends_on:
      structs-pg:
        condition: service_healthy
        restart: true
      structs-webapp:
        condition: service_completed_successfully
    environment:
      - NODE_ENV=production
      - CONSENSUS_RPC_URL=${CONSENSUS_RPC_URL:-http://structsd:26657}
      - CONSENSUS_API_URL=${CONSENSUS_API_URL:-http://structsd:1317}
      - WEBAPP_API_URL=${WEBAPP_API_URL:-http://structs-webapp:8080}
      - NATS_URL=${NATS_URL:-nats://structs-nats:4222}
      - NATS_WEBSOCKET_URL=${NATS_WEBSOCKET_URL:-ws://structs-nats:1443}
      # Database (required for transaction submission and player creation)
      - DATABASE_URL=${DATABASE_URL:-postgres://structs_webapp@structs-pg:5432/structs?serverVersion=17}
      # Database access control:
      # - When DANGER=true: enable database-backed transactions (write operations)
      # - When DANGER=false (default): run in read-only mode via APIs only
      - DANGER=${MCP_DANGER:-false}
      # Proof-of-work configuration (see README and AGE-CALCULATION-AUTOMATIC.md)
      - TARGET_DIFFICULTY_START=${TARGET_DIFFICULTY_START:-7}
      # References feature (optional; defaults keep it disabled but discoverable)
      - REFERENCES_ENABLED=${REFERENCES_ENABLED:-false}
      - MCP_TRANSPORT=${MCP_TRANSPORT:-http}
      - MCP_HTTP_PORT=${MCP_HTTP_PORT:-3000}
      - MCP_HTTP_HOST=${MCP_HTTP_HOST:-0.0.0.0}
    ports:
      - "${MCP_HTTP_PORT:-3000}:3000"  # Expose HTTP port if using HTTP transport
    user: "1001:1001"  # Non-root user (mcp user from Dockerfile)
volumes:
  pgetc:
    name: structs-pg-etc
  pgdata:
    name: structs-pg-data
  chaindata:
    name: structsd-chaindata
  chainshare:
    name: structsd-chainshare
  chainbackup:
    name: structsd-chainbackup
  tsa-keyring: